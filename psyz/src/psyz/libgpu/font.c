#include <psyz.h>
#include <libgpu.h>
#include <libgte.h>
#include <libgs.h>
#include <libetc.h>
#include <log.h>
#include <stdio.h>
#include <stdarg.h>
#include <stdlib.h>
#include <string.h>

static unsigned short fnt_pal[16] = {
    0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000};
static unsigned char fnt_pic[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x10, 0x10, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x11, 0x00, 0x00, 0x11, 0x11, 0x01,
    0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x10, 0x10, 0x00, 0x00, 0x10, 0x10, 0x00, 0x00, 0x01, 0x01, 0x01,
    0x00, 0x11, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00, 0x00, 0x11, 0x00, 0x00,
    0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x01,
    0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x01, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x10, 0x11, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x10, 0x10, 0x00, 0x00, 0x10, 0x11, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x11, 0x11, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10, 0x00, 0x00, 0x00, 0x01, 0x01,
    0x00, 0x10, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x01,
    0x00, 0x01, 0x01, 0x01, 0x00, 0x01, 0x10, 0x01, 0x00, 0x01, 0x10, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x00, 0x00,
    0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x10, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x10, 0x10, 0x00, 0x00, 0x10, 0x11, 0x00, 0x00, 0x01, 0x10, 0x01,
    0x00, 0x10, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x10, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x10, 0x11, 0x00, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x00, 0x10, 0x00, 0x00, 0x11, 0x11, 0x01, 0x00, 0x00, 0x11, 0x00,
    0x00, 0x11, 0x11, 0x01, 0x00, 0x10, 0x11, 0x00, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x01, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x11, 0x00, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x10, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x10, 0x10, 0x00,
    0x00, 0x11, 0x11, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x01, 0x00,
    0x00, 0x10, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x11, 0x11, 0x01,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x01, 0x01, 0x01,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x11, 0x00,
    0x00, 0x01, 0x10, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x11, 0x11, 0x00,
    0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x11, 0x00, 0x00, 0x10, 0x11, 0x01,
    0x00, 0x10, 0x01, 0x00, 0x00, 0x10, 0x01, 0x00, 0x00, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x11, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x00, 0x11, 0x11, 0x01, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x11, 0x11, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x10, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x10, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x01, 0x00,
    0x00, 0x10, 0x01, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x10, 0x11, 0x00, 0x00, 0x11, 0x11, 0x01, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x11, 0x00, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x10, 0x11, 0x00, 0x00, 0x10, 0x01, 0x00,
    0x00, 0x10, 0x01, 0x00, 0x00, 0x10, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x11, 0x00, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x11, 0x11, 0x00, 0x00, 0x10, 0x11, 0x00, 0x00, 0x11, 0x11, 0x00,
    0x00, 0x11, 0x11, 0x01, 0x00, 0x11, 0x11, 0x01, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x11, 0x00, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x11, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x10, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x10, 0x00, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x11, 0x10, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x11, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x10, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x11, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x01, 0x01, 0x00, 0x11, 0x11, 0x01,
    0x00, 0x11, 0x11, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x10, 0x00, 0x01,
    0x00, 0x11, 0x11, 0x00, 0x00, 0x11, 0x11, 0x00, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x11, 0x11, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x11, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x01, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x11, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x10, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x01, 0x10, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x10, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x10, 0x00,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x11, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x11, 0x11, 0x00, 0x00, 0x10, 0x11, 0x00, 0x00, 0x11, 0x11, 0x00,
    0x00, 0x11, 0x11, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x11, 0x00, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x11, 0x11, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x11, 0x11, 0x00, 0x00, 0x10, 0x11, 0x00, 0x00, 0x11, 0x11, 0x00,
    0x00, 0x10, 0x11, 0x00, 0x00, 0x11, 0x11, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x11, 0x11, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x10, 0x10, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x10, 0x00, 0x00, 0x10, 0x10, 0x00,
    0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x11, 0x11, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x11, 0x11, 0x00,
    0x00, 0x10, 0x11, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x11, 0x11, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01,
    0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x10, 0x00, 0x00, 0x01, 0x01, 0x01,
    0x00, 0x10, 0x10, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x01, 0x10, 0x00, 0x00, 0x01, 0x10, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x10, 0x00,
    0x00, 0x11, 0x10, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x10, 0x01, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x10, 0x11, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x10, 0x11, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x11, 0x11, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x11, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

typedef struct {
    TILE tile;
    DR_MODE draw_mode;
    u32 capacity;
    SPRT_8* sprites;
    char* buffer;
    s32 written;
    s32 unwrap;
} FntStream;

FntStream Font[8];
static char fnt_text_buf[0x400];
static SPRT_8 fnt_sprt_buf[0x400];
static int fnt_stream_id;
static int fnt_dump_id;
static int fnt_text_buf_index;
static unsigned short fnt_pic_vram;
static unsigned short fnt_clut_vram;

int (*GPU_printf)(const char*, ...);

void SetDumpFnt(int id) {
    if (id >= 0 && fnt_stream_id >= id) {
        fnt_dump_id = id;
        GPU_printf = FntPrint;
    }
}

void FntLoad(int tx, int ty) {
    fnt_clut_vram = LoadClut2((u_long*)fnt_pal, tx, ty + 128);
    fnt_pic_vram = LoadTPage((u_long*)fnt_pic, 0x00, 0x00, tx, ty, 128, 32);
    fnt_stream_id = 0;
    memset(Font, 0, sizeof(Font));
}

#define FNT_OPEN_2
int FntOpen(int x, int y, int w, int h, int isbg, int n) {
    int i;
    FntStream* font;
    char* buffer;
    SPRT_8* sprites;
    RECT rect = {0, 0, 256, 256};

    if (fnt_stream_id >= LEN(Font)) {
        return -1;
    }
    if (fnt_stream_id == 0) {
        fnt_text_buf_index = 0;
    }
    if (fnt_text_buf_index + n > LEN(fnt_text_buf)) {
        n = LEN(fnt_text_buf) - fnt_text_buf_index;
    }

    font = &Font[fnt_stream_id];
#ifdef FNT_OPEN_2
    font->unwrap = w == 0;
#endif
    SetDrawMode(&font->draw_mode, 0, 0, fnt_pic_vram, 0);
    if (isbg) {
        SetTile(&font->tile);
        font->tile.r0 = 0;
        font->tile.g0 = 0;
        font->tile.b0 = 0;
#ifdef FNT_OPEN_2
        SetSemiTrans(&font->tile, isbg == 2);
#endif
    }
    font->tile.x0 = x;
    font->tile.y0 = y;
    font->tile.w = w;
    font->tile.h = h;
    font->capacity = n;
    font->written = 0;
    font->buffer = &fnt_text_buf[fnt_text_buf_index];
    font->sprites = &fnt_sprt_buf[fnt_text_buf_index];
    font->buffer[0] = '\0';
    for (i = 0; i < n; i++, sprites++) {
        SetSprt8(&font->sprites[i]);
#ifndef FNT_OPEN_2
        SetShadeTex(&font->sprites[i], 1);
#endif
        font->sprites[i].clut = fnt_clut_vram;
    }
    fnt_text_buf_index += n;
    return fnt_stream_id++;
}

u_long* FntFlushInternal(int id);
u_long* FntFlush(int id) {
    return FntFlushInternal(id);
    // FntStream* font;
    // SPRT_8* s;
    // int i;

    // if (id >= LEN(Font)) {
    //     return -1;
    // }
    // if (id < 0) {
    //     id = fnt_dump_id - 1;
    // }
    // font = &Font[fnt_dump_id];
    // if (!font->buffer) {
    //     return -1;
    // }

    // font->written = 0;
    // termPrim(font->sprites);
    // s = font->sprites;
    // for (i = 0; i < font->written; i++, s++) {
    //     s->
    // }
}

u_long* FntFlushInternal(int id) {
    char* buf;
    char ch;

    int v1;          // $v0
    FntStream* f;    // $s3
    int len;    // $fp
    int x;           // $s1
    int y;           // $s5
    SPRT_8* sprt;    // $s2
    int w;           // $s7
    int v12;         // $s4
    char* v13;       // $s0
    char v14;        // $v0
    char v15;        // $v1
    int v16;         // $v1
    int v17;         // $v1
    OT_TYPE* ot;     // [sp+10h] [-18h]
    int v22;         // [sp+14h] [-14h]
    int h;           // [sp+18h] [-10h]
    u_char r;        // [sp+1Ch] [-Ch]
    u_char g;        // [sp+20h] [-8h]
    u_char b;        // [sp+24h] [-4h]

    r = 0x80;
    g = 0x80;
    v22 = 0;
    b = 0x80;
    if (id < 0 || id >= fnt_stream_id) {
        id = fnt_dump_id;
        if (!Font[fnt_dump_id].buffer) {
            return 0;
        }
    }
    v1 = 2 * fnt_dump_id;
    f = (FntStream*)((char*)Font + 16 * v1 + 16 * id);
    ot = (OT_TYPE*)&f->draw_mode.tag;
    buf = f->buffer;
    len = f->capacity;
    x = f->tile.x0;
    y = f->tile.y0;
    h = y + f->tile.h;
    sprt = f->sprites;
    w = x + f->tile.w;
    termPrim(&f->draw_mode);
    while (1) {
        ch = *buf;
        if (!*buf || !len)
            break;
        v12 = 0;
        if (ch == ' ')
            goto LABEL_20;
        if (ch < 33) {
            if (ch != 9) {
                if (ch != 10) {
                LABEL_16:
                    v16 = (unsigned char)*buf;
                    if ((unsigned int)(v16 - 97) >= 0x1A)
                        v17 = (char)v16 - 32;
                    else
                        v17 = (char)v16 - 64;
                    sprt->u0 = 8 * (v17 % 16);
                    sprt->v0 = 8 * (v17 / 16);
                    sprt->x0 = x;
                    sprt->y0 = y;
                    sprt->r0 = r;
                    sprt->g0 = g;
                    sprt->b0 = b;
                    AddPrim(ot, sprt++);
                LABEL_20:
                    x += 8;
                LABEL_21:
                    if (x < w || f->unwrap)
                        goto LABEL_24;
                }
                v12 = 1;
                goto LABEL_24;
            }
            x += 32;
            goto LABEL_21;
        }
        if (ch != 126)
            goto LABEL_16;
        if (*++buf == 'c') {
            r = 16 * (*++buf - 48);
            g = 16 * (*++buf - 48);
            b = 16 * (*++buf - 48);
        }
    LABEL_24:
        if (v12) {
            if (v22 < x)
                v22 = x;
            y += 8;
            x = f->tile.x0;
            if (y >= h)
                break;
        }
        buf++;
        len--;
    }
    if (f->tile.code) {
        AddPrim(ot, f);
        if (f->unwrap) {
            f->tile.w = v22 - f->tile.x0;
            f->tile.h = y - (f->tile.y0 - 8);
        }
    }
    DrawOTag(ot);
    f->written = 0;
    f->buffer[0] = '\0';
    return (u_long*)&f->draw_mode;
}

int FntPrint(const char* fmt, ...) {
    FntStream* font;
    int left;

    if (fnt_dump_id < 0 || fnt_dump_id >= LEN(Font)) {
        return -1;
    }
    font = &Font[fnt_dump_id];
    if (!font->buffer) {
        return -1;
    }
    left = font->capacity - font->written;
    if (left <= 0) {
        return -1;
    }

    int n;
    va_list args;
    va_start(args, fmt);
    n = vsnprintf(font->buffer + font->written, left, fmt, args);
    font->written += n;
    va_end(args);
    return n;
}
